<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESP32 Health Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#f5f7fa; margin:0; padding:0; }
    header { background:#3f51b5; color:#fff; text-align:center; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
    h1 { margin:0; font-size:2rem; }
    #status { text-align:center; color:red; font-weight:bold; margin:15px 0; }
    .dashboard { display:flex; flex-wrap:wrap; justify-content:center; gap:30px; padding:20px; }
    .card { background:#fff; border-radius:15px; box-shadow:0 4px 8px rgba(0,0,0,0.1); padding:20px; width:400px; display:flex; flex-direction:column; align-items:center; }
    .card h2 { margin:0 0 10px 0; font-size:1.2rem; color:#333; }
    .value { font-size:2rem; font-weight:bold; margin-bottom:15px; color:#3f51b5; }
    canvas { width:100% !important; height:250px !important; }
  </style>
</head>
<body>
  <header><h1>ESP32 Health Dashboard</h1></header>
  <div id="status"></div>
  <div class="dashboard">
    <div class="card">
      <h2>Heart Rate (BPM)</h2>
      <div class="value" id="heartrateValue">--</div>
      <canvas id="heartrateChart"></canvas>
    </div>
    <div class="card">
      <h2>SpO2 (%)</h2>
      <div class="value" id="spo2Value">--</div>
      <canvas id="spo2Chart"></canvas>
    </div>
  </div>

  <script>
    let heartrateChart, spo2Chart;

    async function fetchData() {
      try {
        const res = await fetch(`/api/sensor?time=${Date.now()}`); // منع cache
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        return Array.isArray(data) ? data : [];
      } catch (err) {
        document.getElementById('status').textContent = `Error fetching data: ${err.message}`;
        console.error(err);
        return [];
      }
    }

    function cleanData(sensorData) {
      return sensorData.map(d => ({
        time: d.time,
        heartrate: (d.heartrate >= 30 && d.heartrate <= 220) ? d.heartrate : null,
        spo2: (d.spo2 >= 50 && d.spo2 <= 100) ? d.spo2 : null
      }));
    }

    function updateValues(sensorData) {
      const latestHR = [...sensorData].reverse().find(d => d.heartrate != null);
      const latestSpO2 = [...sensorData].reverse().find(d => d.spo2 != null);

      document.getElementById('heartrateValue').textContent = latestHR ? latestHR.heartrate : '--';
      document.getElementById('spo2Value').textContent = latestSpO2 ? latestSpO2.spo2 : '--';
    }

    function getYMax(values, defaultMax) {
      const filtered = values.filter(v => v != null);
      return filtered.length ? Math.max(...filtered) * 1.2 : defaultMax;
    }

    function renderCharts(sensorData) {
      const cleaned = cleanData(sensorData);
      const timestamps = cleaned.map(d => new Date(d.time).toLocaleTimeString());
      const heartrate = cleaned.map(d => d.heartrate);
      const spo2 = cleaned.map(d => d.spo2);

      if (heartrateChart) heartrateChart.destroy();
      if (spo2Chart) spo2Chart.destroy();

      heartrateChart = new Chart(document.getElementById('heartrateChart'), {
        type: 'line',
        data: { labels: timestamps, datasets: [{ label:'Heart Rate', data:heartrate, borderColor:'#e53935', backgroundColor:'rgba(229,57,53,0.2)', fill:true, tension:0.3 }] },
        options: { responsive:true, scales:{ y:{ beginAtZero:true, max:getYMax(heartrate,150) } } }
      });

      spo2Chart = new Chart(document.getElementById('spo2Chart'), {
        type: 'line',
        data: { labels: timestamps, datasets: [{ label:'SpO2', data:spo2, borderColor:'#1e88e5', backgroundColor:'rgba(30,136,229,0.2)', fill:true, tension:0.3 }] },
        options: { responsive:true, scales:{ y:{ beginAtZero:true, max:getYMax(spo2,100) } } }
      });
    }

    async function refreshDashboard() {
      const sensorData = await fetchData();
      if (!sensorData.length) {
        document.getElementById('status').textContent = 'No data available.';
        updateValues([]);
        renderCharts([]);
        return;
      }
      document.getElementById('status').textContent = '';
      updateValues(sensorData);
      renderCharts(sensorData);
    }

    refreshDashboard();
    setInterval(refreshDashboard, 10000);
  </script>
</body>
</html>
